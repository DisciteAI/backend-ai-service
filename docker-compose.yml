version: '3.8'

services:
  # AI Training Service (Python FastAPI)
  ai-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-training-service
    ports:
      - "8000:8000"
    environment:
      # Application settings
      - ENVIRONMENT=production
      - DEBUG=false

      # Database connection
      - DATABASE_URL=postgresql+asyncpg://aiuser:aipass@ai-postgres:5432/aitraining

      # Google Gemini API
      - GEMINI_API_KEY=AIzaSyAbZ1vrvMXwN6BDzzbvUg3Nmc1JecgWES0
      - GEMINI_MODEL=gemini-1.5-flash
      - GEMINI_TEMPERATURE=0.7

      # .NET API integration (update with your .NET service URL)
      - DOTNET_API_URL=${DOTNET_API_URL:-http://backend-api:8080}
      - SERVICE_API_KEY=${SERVICE_API_KEY:-}

      # Session settings
      - MAX_CONVERSATION_HISTORY=50
      - COMPLETION_MARKER={TOPIC_COMPLETED}

      # CORS
      - CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]

    depends_on:
      ai-postgres:
        condition: service_healthy
    networks:
      - ai-network
    restart: unless-stopped

  # PostgreSQL database for AI service
  ai-postgres:
    image: postgres:18-alpine
    container_name: ai-postgres
    ports:
      - "5433:5432"  # Different port to avoid conflict with .NET postgres
    environment:
      - POSTGRES_USER=aiuser
      - POSTGRES_PASSWORD=aipass
      - POSTGRES_DB=aitraining
    volumes:
      - ai-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aiuser -d aitraining"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-network
    restart: unless-stopped

networks:
  ai-network:
    driver: bridge

volumes:
  ai-postgres-data:
